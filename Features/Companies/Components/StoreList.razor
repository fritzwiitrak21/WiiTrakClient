@using WiiTrakClient.Features.Companies.Components
@inject IDialogService DialogService

@inject IStoreHttpRepository StoreHttpRepository
@inject ICorporateHttpRepository CorporateRepository
@inject ICompanyHttpRepository CompanyRepository
@inject ICountyCodeHttpRepository CountyCodeRepository
@using WiiTrakClient.Cores


<MudTable Items="@Stores" Class="Pagingstyle" Hover="true" SortLabel="Sort By">
    <HeaderContent>
        <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<StoreDto, object>(x=>x.StoreName)">Store Name</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<StoreDto, object>(x=>x.StoreNumber)">Store Number</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<StoreDto, object>(x=>x.StreetAddress1)">Street Address</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<StoreDto, object>(x=>x.City)">City</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<StoreDto, object>(x=>x.State)">State</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<StoreDto, object>(x=>x.PostalCode)">Postal Code</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<StoreDto, object>(x=>x.CountyCode)">County Code</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<StoreDto, object>(x=>x.ServiceFrequency)">Service Frequency</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<StoreDto, object>(x=>x.Email)">Email</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<StoreDto, object>(x=>x.PhonePrimary)">Phone</MudTableSortLabel></MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Store Name">
            @context.StoreName
        </MudTd>
        <MudTd DataLabel="Store Number">
            @context.StoreNumber
        </MudTd>
        <MudTd DataLabel="Street Address 1">
            @context.StreetAddress1
        </MudTd>
        <MudTd DataLabel="City">
            @context.City
        </MudTd>
        <MudTd DataLabel="State">
            @context.State
        </MudTd>

        <MudTd DataLabel="Postal Code">
            @context.PostalCode
        </MudTd>
        <MudTd DataLabel="County Code">
            @context.CountyCode
        </MudTd>
         <MudTd DataLabel="Service Frequency">
            @context.ServiceFrequency
        </MudTd>
        <MudTd DataLabel="Email">
            @context.Email
        </MudTd>
        <MudTd DataLabel="Phone">
            @context.PhonePrimary
        </MudTd>

        <MudTd DataLabel="Action">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="((e) => OpenDialog(context))">
                Update
            </MudButton>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager PageSizeOptions="new int[]{10, 50, 100}" />
    </PagerContent>
</MudTable>


@code {
    [Parameter]
    public List<StoreDto>? Stores { get; set; } = null;
    private bool _enabled = true;
    public CompanyDto Company { get; set; }
    public List<CorporateDto> Corporate { get; set; } = new();
    public List<CountyCodeDTO> CountyCode { get; set; } = new();
    public async Task OpenDialog(StoreDto store)
    {

        // TODO Update for store

        if (CurrentUser.UserRole == "PrimeCompany")
        {
            Corporate = await CorporateRepository.GetCorporatesByCompanyId(CurrentUser.UserId);

        }
        else if (CurrentUser.UserRole == "SubContractor")
        {
            Company = await CompanyRepository.GetParentCompanyAsync(CurrentUser.UserId);
            Corporate = await CorporateRepository.GetCorporatesByCompanyId((Guid)Company.ParentId);
        }
        Console.WriteLine("store id: " + store.Id);
        CountyCode=await CountyCodeRepository.GetCountyListAsync();

        var parameters = new DialogParameters();
        parameters.Add("Store", store);
        parameters.Add("Corporate", Corporate);
        parameters.Add("CountyCodeList", CountyCode);
        DialogOptions options = new DialogOptions() { MaxWidth = MaxWidth.Large };

        var dialog = DialogService.Show<UpdateStoreDialog>("Update Store", parameters);
        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            // save updated store to backend
            var storeUpdate = new StoreUpdateDto
                {
                    StoreName = store.StoreName,
                    StreetAddress1 = store.StreetAddress1,
                    StreetAddress2 = store.StreetAddress2,
                    City = store.City,
                    State = store.State,
                    PostalCode = store.PostalCode,
                    ProfilePicUrl = store.ProfilePicUrl,
                    Email = store.Email,
                    PhonePrimary = store.PhonePrimary,
                    PhoneSecondary = store.PhoneSecondary,
                    ServiceProviderId = Guid.Empty,
                    CorporateId = store.CorporateId,
                    CompanyId = store.CompanyId,
                    StoreNumber = store.StoreNumber,
                    IsActive = store.IsActive,
                    CountyCode = store.CountyCode,
                    ServiceFrequency = store.ServiceFrequency,
                    StartDate = store.StartDate

                };
            await StoreHttpRepository.UpdateStoreAsync(store.Id, storeUpdate);
        }
        Stores = await StoreHttpRepository.GetStoresByCompanyId(CurrentUser.UserId);
    }
}